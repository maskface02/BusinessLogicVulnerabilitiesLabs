import re
import sys
import urllib3
import requests
from bs4 import BeautifulSoup
from datetime import datetime
from utils import get_csrf_token
from urllib.parse import urljoin

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
EMAIL_RE = re.compile(r'[\w.+-]+@[\w.-]+\.[a-zA-Z]{2,}')

def get_mail_server_url(session: requests.Session, url: str) -> str:
    r = session.get(url, verify=False)
    r.raise_for_status()

    soup = BeautifulSoup(r.text, "html.parser")
    a = soup.find("a", {"id":"exploit-link"})

    href = a.get("href") if a else None
    if not href:
        raise RuntimeError(f"Could not find Mail Server URL on: {url}")

    return href 

def get_email(session: requests.Session, url: str) -> str | None:
    response = session.get(url, verify = False)
    response.raise_for_status()

    soup = BeautifulSoup(response.text, "html.parser")
    for h4 in soup.find_all("h4"):
        text = h4.get_text(" ", strip=True)
        if "Your email address is" in text:
            m = EMAIL_RE.search(text)
            return m.group(0) if m else None
    return None

def get_latest_verification_link(session: requests.Session, mail_url: str):
    r = session.get(mail_url, verify=False, timeout=15)
    r.raise_for_status()

    soup = BeautifulSoup(r.text, "html.parser")
    rows = soup.select("table tr")[1:]  # skip header

    latest_dt = None
    latest_link = None

    for tr in rows:
        tds = tr.find_all("td")
        if len(tds) < 5:
            continue

        sent_str = tds[0].get_text(strip=True)  # "2026-02-15 23:20:16 +0000"
        try:
            dt = datetime.strptime(sent_str, "%Y-%m-%d %H:%M:%S %z")
        except ValueError:
            continue

        body_td = tds[4]
        a = body_td.find("a", href=True)
        if not a:
            continue

        link = urljoin(mail_url, a["href"])

        if latest_dt is None or dt > latest_dt:
            latest_dt = dt
            latest_link = link

    return latest_link

def login(session: requests.Session, base_url: str, username: str, password: str) -> None:
    login_url = f"{base_url}/login"
    csrf = get_csrf_token(session, login_url)

    response = session.post(
        login_url,
        data={"csrf": csrf, "username": username, "password": password},
        verify=False
    )
    response.raise_for_status()

    if "/my-account" not in response.url:
        raise RuntimeError("Login failed")

    print(f"Successfully logged-in as {username}")

def delete_carlos(session: requests.Session, base_url: str) -> None:
    base_url = base_url.rstrip("/")

    # 1) register
    register_url = f"{base_url}/register"
    csrf_token = get_csrf_token(session, register_url)
    print(f"csrf_token : {csrf_token}")
    mail_server_url = get_mail_server_url(session, register_url)
    print(f"mail_server_url : {mail_server_url}")
    email = get_email(session,mail_server_url)
    print(f"mail address :{email}")
    print(f"(+) Trying to register with test and email = {email} and pass = 12345")
    register_data = {"csrf": csrf_token, "username": "test", "email": email, "password": "1234"}
    response = session.post(register_url, data=register_data)
    response.raise_for_status()
    v_link = get_latest_verification_link(session, mail_server_url)
    if not v_link:
        raise RuntimeError("No verification link found yet (email not arrived).")
    print("Verifying the account... ")
    response = session.get(v_link, verify=False)

    #2) Login
    login(session, base_url, username="test", password="1234")

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    delete_carlos(session, sys.argv[1])

if __name__ == "__main__":
    main()
